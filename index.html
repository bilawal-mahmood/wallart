<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Wall AR Tilt Control</title>
  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <style>
    html, body { margin: 0; padding: 0; overflow: hidden; }
    #renderCanvas { width: 100%; height: 100%; touch-action: none; }
    #log {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.6);
      color: lime;
      font-size: 14px;
      padding: 10px;
      max-width: 90%;
      z-index: 10;
      font-family: monospace;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <canvas id="renderCanvas"></canvas>
  <div id="log">Initializing…</div>

  <script>
    let engine, scene, reticle, placedImage;
    let dragPlaneY = 0;
    let moveSpeed = 0.02;  // sensitivity

    const log = msg => document.getElementById("log").innerText = "Status: " + msg;

    async function createScene() {
      const canvas = document.getElementById("renderCanvas");
      engine = new BABYLON.Engine(canvas, true);
      scene = new BABYLON.Scene(engine);
      new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);

      const xr = await BABYLON.WebXRDefaultExperience.CreateAsync(scene, {
        uiOptions: { sessionMode: "immersive-ar" },
        optionalFeatures: true
      });

      const hitTest = await xr.baseExperience.featuresManager.enableFeature(
        BABYLON.WebXRHitTest.Name, "latest", { xrInput: xr.input }
      );

      // Floor strip
      reticle = BABYLON.MeshBuilder.CreateBox("strip", {
        width: 0.6, height: 0.01, depth: 0.02
      }, scene);
      reticle.material = new BABYLON.StandardMaterial("mat", scene);
      reticle.material.diffuseColor = new BABYLON.Color3(0, 1, 0);
      reticle.isVisible = false;

      let initialSet = false;

      hitTest.onHitTestResultObservable.add(results => {
        if (results.length && !initialSet) {
          let hit = results[0];
          let scale = new BABYLON.Vector3();
          let rotation = new BABYLON.Quaternion();
          let position = new BABYLON.Vector3();
          hit.transformationMatrix.decompose(scale, rotation, position);

          // Align strip with camera Y rotation
          const camRotY = xr.baseExperience.camera.rotationQuaternion.toEulerAngles().y;
          reticle.rotationQuaternion = BABYLON.Quaternion.RotationAxis(BABYLON.Axis.Y, camRotY);
          reticle.position = position.clone();
          reticle.position.y += 0.005;

          dragPlaneY = reticle.position.y;
          reticle.isVisible = true;
          initialSet = true;

          log("Tilt phone to move strip. Tap to place image.");
        }
      });

      // Move strip using phone tilt (onBeforeRender)
      scene.onBeforeRenderObservable.add(() => {
        if (!reticle || !reticle.isVisible || placedImage) return;

        const camera = xr.baseExperience.camera;

        const forward = camera.getDirection(BABYLON.Axis.Z);
        const right = camera.getDirection(BABYLON.Axis.X);

        const pitch = Math.asin(forward.y); // up/down tilt
        const roll = Math.asin(right.y);    // left/right tilt

        const move = new BABYLON.Vector3();

        // Roll → move left/right
        move.addInPlace(new BABYLON.Vector3(right.x, 0, right.z).scale(-roll * moveSpeed));
        // Pitch → move forward/back
        move.addInPlace(new BABYLON.Vector3(forward.x, 0, forward.z).scale(-pitch * moveSpeed));

        reticle.position.addInPlace(move);
        reticle.position.y = dragPlaneY;
      });

      // Tap to place image
      scene.onPointerDown = () => {
        if (!reticle.isVisible || placedImage) return;

        const img = BABYLON.MeshBuilder.CreatePlane("art", {
          width: 0.6, height: 0.6
        }, scene);
        img.position = reticle.position.clone();
        img.position.y += 0.3;

        const camRotY = xr.baseExperience.camera.rotationQuaternion.toEulerAngles().y;
        img.rotationQuaternion = BABYLON.Quaternion.RotationAxis(BABYLON.Axis.Y, camRotY);

        const mat = new BABYLON.StandardMaterial("imgMat", scene);
        mat.diffuseTexture = new BABYLON.Texture("art.png", scene);
        mat.emissiveColor = new BABYLON.Color3(1, 1, 1);
        img.material = mat;

        placedImage = img;
        log("Image placed.");
      };

      engine.runRenderLoop(() => scene.render());
      window.addEventListener("resize", () => engine.resize());
    }

    createScene().catch(err => {
      console.error(err);
      log("Error: " + err.message);
    });
  </script>
</body>
</html>
